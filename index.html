<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Tornado-mongodb-example-app by rajasankar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Tornado-mongodb-example-app</h1>
      <h2 class="project-tagline">simple example webserver using tornado-mongodb using nginx and supervisor.</h2>
      <a href="https://github.com/rajasankar/tornado-mongodb-example-app" class="btn">View on GitHub</a>
      <a href="https://github.com/rajasankar/tornado-mongodb-example-app/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/rajasankar/tornado-mongodb-example-app/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p>Tornado and MongoDB needs no introduction. Here I am going to explain how to host an app/API with Tornado+MongoDB using Nginx server as a proxy/load balancing and supervisor for process management.</p>

<p>This simple configuration can be done with few hours to up and run the site/API. This configuration runs my site <a href="http://naturaltext.com">NaturalText</a>. </p>

<p>First let us see the Tornado sample code.</p>

<h4>
<a id="template-and-static-file-paths" class="anchor" href="#template-and-static-file-paths" aria-hidden="true"><span class="octicon octicon-link"></span></a>Template and Static file paths:</h4>

<p>Tornado has options to define, templates and statics file paths. For static paths, ensure that, you're calling <em>/static/</em> followed by file name. ie /static/static file (eg http://localhost/static/jquery.js). This can be changed using <strong>static_url_prefix</strong> option in the settings.</p>

<p>example code:</p>

<div class="highlight highlight-python"><pre>template_path <span class="pl-k">=</span> os.path.join( <span class="pl-s"><span class="pl-pds">'</span>/home/test/website/<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">"</span>templates<span class="pl-pds">"</span></span> ),
static_path <span class="pl-k">=</span> os.path.join( <span class="pl-s"><span class="pl-pds">'</span>/home/test/website/<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>assets<span class="pl-pds">'</span></span> )</pre></div>

<p>or simply,</p>

<div class="highlight highlight-python"><pre>template_path <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>/home/test/website/templates<span class="pl-pds">'</span></span>,
static_path <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>/home/test/website/assets<span class="pl-pds">'</span></span></pre></div>

<h4>
<a id="defining-portdb-settings" class="anchor" href="#defining-portdb-settings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining port/db settings</h4>

<p>Passing the command line defined using "options" or parsed command line arguments using parse_command_line option.</p>

<div class="highlight highlight-python"><pre>define( <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span>, <span class="pl-smi">default</span> <span class="pl-k">=</span> <span class="pl-c1">8888</span>, <span class="pl-smi">type</span> <span class="pl-k">=</span> <span class="pl-c1">int</span> )
parse_command_line()</pre></div>

<h4>
<a id="defining-handlers-for-different-paths" class="anchor" href="#defining-handlers-for-different-paths" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining handlers for different paths</h4>

<p>For mapping which URL path should be served by which function handled by adding handlers. It supports map based on regular expressions too.</p>

<div class="highlight highlight-python"><pre>handlers <span class="pl-k">=</span> [( <span class="pl-s"><span class="pl-k">r</span><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, HomeHandler ),
            ( <span class="pl-s"><span class="pl-k">r</span><span class="pl-pds">"</span>/api<span class="pl-pds">"</span></span>, MyAPIHandler ),
            ( <span class="pl-s"><span class="pl-k">r</span><span class="pl-pds">"</span>/demo<span class="pl-pds">"</span></span>, DemoUI )
            ]</pre></div>

<p>functions</p>

<div class="highlight highlight-python"><pre><span class="pl-k">class</span> <span class="pl-en">DemoUI</span>( <span class="pl-e">BaseHandler</span> )
    <span class="pl-k">def</span> <span class="pl-en">get</span>( <span class="pl-smi">self</span> ):
        number<span class="pl-k">=</span> [i <span class="pl-k">for</span> i <span class="pl-k">in</span> <span class="pl-c1">range</span>(<span class="pl-c1">0</span>,<span class="pl-c1">10</span>) ]
        <span class="pl-v">self</span>.render( <span class="pl-s"><span class="pl-pds">"</span>one.html<span class="pl-pds">"</span></span> , <span class="pl-smi">title</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>one<span class="pl-pds">"</span></span>,<span class="pl-smi">numberlist</span><span class="pl-k">=</span>number )
<span class="pl-k">class</span> <span class="pl-en">HomeHandler</span>( <span class="pl-e">BaseHandler</span> ):
    <span class="pl-k">def</span> <span class="pl-en">get</span>( <span class="pl-smi">self</span> ):
        <span class="pl-v">self</span>.render( <span class="pl-s"><span class="pl-pds">"</span>index.html<span class="pl-pds">"</span></span> )</pre></div>

<p><strong>render</strong> renders the <em>HTML template</em> with the variables.</p>

<h4>
<a id="rendering-data-in-html-template" class="anchor" href="#rendering-data-in-html-template" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rendering data in HTML template</h4>

<p>To show the data in HTML template, pass the data to the variable defined in the template using <em>render</em> function.</p>

<p><strong>numberlist</strong> is defined in the template, so <em>render</em> functions should pass the date to <em>numberlist</em> variable.</p>

<div class="highlight highlight-html"><pre>&lt;<span class="pl-ent">html</span>&gt;
   &lt;<span class="pl-ent">head</span>&gt;
      &lt;<span class="pl-ent">title</span>&gt;{{ title }}&lt;/<span class="pl-ent">title</span>&gt;
   &lt;/<span class="pl-ent">head</span>&gt;
   &lt;<span class="pl-ent">body</span>&gt;
    &lt;<span class="pl-ent">div</span>&gt;
        &lt;<span class="pl-ent">table</span>&gt;
         {% for number in numberlist %}
         &lt;<span class="pl-ent">tr</span>&gt;
            &lt;<span class="pl-ent">td</span>&gt;{{ number }}&lt;/<span class="pl-ent">td</span>&gt;
         &lt;/<span class="pl-ent">tr</span>&gt;
         {% end %}
         &lt;/<span class="pl-ent">table</span>&gt;
        &lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
   &lt;/<span class="pl-ent">body</span>&gt;
&lt;/<span class="pl-ent">html</span>&gt;</pre></div>

<h4>
<a id="setting-multiple-inheritance" class="anchor" href="#setting-multiple-inheritance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting multiple inheritance</h4>

<p>Multiple inheritance useful for things such as reusing db connections etc.</p>

<div class="highlight highlight-python"><pre><span class="pl-c1">super</span>( Example, <span class="pl-v">self</span> ).__init__( handlers, <span class="pl-k">**</span>settings )</pre></div>

<h4>
<a id="basehandler-for-property-definition" class="anchor" href="#basehandler-for-property-definition" aria-hidden="true"><span class="octicon octicon-link"></span></a>BaseHandler for property definition</h4>

<p>Once the property is defined in the basehandler, it will be available to all the handlers. In the example, property for connecting db is defined.</p>

<p>create connection in the <strong>init</strong> function</p>

<div class="highlight highlight-python"><pre>session <span class="pl-k">=</span> MongoClient()
<span class="pl-v">self</span>.firstCol <span class="pl-k">=</span> session.firstDB.firstCol
<span class="pl-v">self</span>.secondCol <span class="pl-k">=</span> session.secondDB.secondCol</pre></div>

<p>define the property in a <strong>basehandler</strong> class</p>

<div class="highlight highlight-python"><pre><span class="pl-k">class</span> <span class="pl-en">BaseHandler</span>( <span class="pl-e">tornado.web.RequestHandler</span> ):
    <span class="pl-en">@<span class="pl-c1">property</span></span>
    <span class="pl-k">def</span> <span class="pl-en">secondCol</span>( <span class="pl-smi">self</span> ):
        <span class="pl-k">return</span> <span class="pl-v">self</span>.application.secondCol
    <span class="pl-en">@<span class="pl-c1">property</span></span>
    <span class="pl-k">def</span> <span class="pl-en">firstCol</span>( <span class="pl-smi">self</span> ):
        <span class="pl-k">return</span> <span class="pl-v">self</span>.application.firstCol</pre></div>

<p>Now, calling <strong>self.firstcol</strong> from any function refers to the db connection. </p>

<h4>
<a id="logging" class="anchor" href="#logging" aria-hidden="true"><span class="octicon octicon-link"></span></a>Logging</h4>

<p>Tornado enables default logging for access,error and general loggers. This can be turned off using <strong>--logging=none</strong> option when starting the server. Logging to separate output file is done using python loggers. However, to turn off default logging and log only needed(custom logging), default logger should be propagated to false, else all logs would be logged too. In the example, only access log is turned off. </p>

<div class="highlight highlight-python"><pre>options.logging <span class="pl-k">=</span> <span class="pl-c1">None</span>
access <span class="pl-k">=</span> logging.NullHandler()
access.setLevel( logging.DEBUG )
logging.getLogger( <span class="pl-s"><span class="pl-pds">"</span>tornado.access<span class="pl-pds">"</span></span> ).addHandler( access )
logging.getLogger( <span class="pl-s"><span class="pl-pds">"</span>tornado.access<span class="pl-pds">"</span></span> ).propagate <span class="pl-k">=</span> <span class="pl-c1">False</span> <span class="pl-c">#turn off access log</span>
LOG_FILENAME <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>/home/test/logging.log<span class="pl-pds">'</span></span>
handler <span class="pl-k">=</span> logging.handlers.RotatingFileHandler( LOG_FILENAME, <span class="pl-smi">maxBytes</span> <span class="pl-k">=</span> <span class="pl-c1">1</span> <span class="pl-k">*</span> <span class="pl-c1">1024</span> <span class="pl-k">*</span> <span class="pl-c1">1024</span>, <span class="pl-smi">backupCount</span> <span class="pl-k">=</span> <span class="pl-c1">10</span> )
formatter <span class="pl-k">=</span> logging.Formatter(
        <span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">%(asctime)s</span> process [<span class="pl-c1">%(process)d</span>]: <span class="pl-c1">%(message)s</span><span class="pl-pds">'</span></span>,
        <span class="pl-s"><span class="pl-pds">'</span><span class="pl-c1">%b</span> <span class="pl-c1">%d</span> <span class="pl-c1">%H</span>:<span class="pl-c1">%M</span>:<span class="pl-c1">%S</span><span class="pl-pds">'</span></span> )
handler.setFormatter( formatter )
logger <span class="pl-k">=</span> logging.getLogger()
logger.addHandler( handler )
logger.setLevel( logging.DEBUG )</pre></div>

<h4>
<a id="using-xsrf-cookie-to-make-app-secure" class="anchor" href="#using-xsrf-cookie-to-make-app-secure" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using xsrf cookie to make app secure</h4>

<p>Restricting the access of the app to browser for disabling automatic crawling is simple in Tornado. Add </p>

<div class="highlight highlight-python"><pre>xsrf_cookies <span class="pl-k">=</span> <span class="pl-c1">True</span></pre></div>

<p>to the settings and add below code to HTML POST form</p>

<div class="highlight highlight-html"><pre>{ % module xsrf_form_html() % }
</pre></div>

<p>When loading the HTML form, <em>xsrf cookie</em> will be rendered as hidden parameter. Tornado automatically checks the cookie. </p>

<p><em>xsrf cookie</em> check can skipped for one particular handler. </p>

<div class="highlight highlight-python"><pre>   <span class="pl-k">def</span> <span class="pl-en">check_xsrf_cookie</span>( <span class="pl-smi">self</span> ):
        <span class="pl-k">pass</span></pre></div>

<p>Adding this code, disables <em>xsrf cookie</em> check for that particular handler only. </p>

<h3>
<a id="configuring-nginx" class="anchor" href="#configuring-nginx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring Nginx</h3>

<p>Tornado is an web server itself, so why <a href="http://nginx.org">Nginx</a> needed?</p>

<p>Nginx is used as a proxy server and load balancer. Nginx sits between the server and client, distributes the traffic and offers additional controls as rate limiting etc.</p>

<p>Load Balancing with Nginx is easy. Let us say, four process running in a single machine and each process to handle the requests from users simultaneously, can be configured in Nginx conf.</p>

<p>Each process running in separate port will be connected to Nginx sever and Nginx's port shown to the user.</p>

<h4>
<a id="defining-app-ip-settings" class="anchor" href="#defining-app-ip-settings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining app IP settings</h4>

<pre lang="conf"><code>upstream myapp
    {
        server 127.0.0.1:8888;
        server 127.0.0.1:8889;
        server 127.0.0.1:8890;
        server 127.0.0.1:8891;
    }
</code></pre>

<p>here, one server is going to listen all the four IPs. Defining various IPs using various ports is also available.</p>

<h4>
<a id="defining-server-option" class="anchor" href="#defining-server-option" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining server option</h4>

<pre lang="conf"><code>   server
    {
      listen 127.0.0.1:80;

      location /
      {
        proxy_pass http://myapp;
        proxy_set_header X-Real-IP $remote_addr;
        limit_req zone=index burst=1;
      }

      location /api/
      {
        proxy_pass http://myapp;
        proxy_set_header X-Real-IP $remote_addr;
        limit_req zone=api burst=10 nodelay;
      }

    }
</code></pre>

<p><strong>listen</strong> is self explanatory. It exposes Nginx's running port to public.</p>

<p><strong>proxy_pass</strong> takes care of the load balancing between requests. Without that load wont be distributed.</p>

<p><strong>proxy_set_header</strong> sets the actual IP of the request in the request headers. Which means, requests has the actual IP from which, the app is accessed instead of Nginx server's IP. </p>

<p><strong>limit_req zone</strong> option defines the number of requests the server can handle per second or minute. </p>

<p>For example, </p>

<pre lang="conf"><code>limit_req_zone $binary_remote_addr zone=api:1m  rate=100r/s;
</code></pre>

<p><strong>burst</strong> allows how many requests can be handled at a time and <strong>nodelay</strong> configures, if the requests should be put into the queue or not.</p>

<p>if <strong>rate</strong> is 100r/s and <strong>burst</strong> is 10 with <strong>nodelay</strong>, then 10 requests would be processed in batches.</p>

<h3>
<a id="using-supervisor" class="anchor" href="#using-supervisor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Supervisor</h3>

<p>Handling start/shutdown of the processes can be handled using <a href="http://supervisord.org">Supervisor</a></p>

<p>let us say, four processes needs to be started for tornado,
use this supervisor configuration to start those processes</p>

<pre lang="conf"><code>[program:firstapp]
process_name=firstapp%(process_num)s
directory=/home/test/
command=python /home/test/tornado_example.py --port=%(process_num)s --logging=debug
stdout_logfile=/home/test/out-%(process_num)s.log
stderr_logfile=/home/test/err-%(process_num)s.log
startsecs=2
numprocs=4
numprocs_start=8888
</code></pre>

<p>Supervisor restarts the processes if Tornado exits because of an exception or system reboot.</p>

<p>For comments, please connect <a href="http://twitter.com/rajasankar">@rajasankar</a> , <a href="http://facebook.com/rajasankar">Rajasankar</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/rajasankar/tornado-mongodb-example-app">Tornado-mongodb-example-app</a> is maintained by <a href="https://github.com/rajasankar">rajasankar</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

